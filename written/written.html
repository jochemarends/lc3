<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<title>Virtual Machines</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article">
<div id="header">
<h1>Virtual Machines</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph text-center">
<p>Jochem Arends</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Virtual Machine (VM) are programs that emulates computer hardware.
Virtual machines make it possible to run programs that aren&#8217;t written for your device.
Virtual machines don&#8217;t directly run on the hardware they emulate but are rather applications run by an operating system.
In this document I&#8217;m going to explain how I wrote a virtual machine using C&#43;&#43;.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_little_computer_3">Little Computer 3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Little Computer 3 (LC-3) is an educational computer architecuture developed at the University of Texas at Austin.
The LC-3 has a simple yet versatile instruction set.
Many programs for this architecture can be found online, which is great for testing the virtual machine.
Besides programs, on the internet, tools for this architecture can be found, including an assembler and a C compiler.</p>
</div>
<div class="paragraph">
<p>In this document I won&#8217;t explain the syntax of the LC-3 assembly language or how to write programs for this architecture.
Rather I will explain how I&#8217;ve implemented the virtual machine, how the instruction are encoded, and what each instruction does.</p>
</div>
<div class="paragraph">
<p>Througout this document I will often refer to the LC-3 ISA.
This is a document that describes the architecture of the LC-3 and can be found at <a href="https://www.jmeiners.com/lc3-vm/supplies/lc3-isa.pdf" class="bare">www.jmeiners.com/lc3-vm/supplies/lc3-isa.pdf</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_general_purpose_registers">General Purpose Registers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Registers are a type of computer memory that typically is build into the CPU.
This type of memory is usually faster to access for a CPU than RAM.
The LC-3 has eight 16-bit general purpose registers, these are called <code>R0-R7</code>.
The general purpose registers are used as operands for instructions or to store results.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_program_counter">Program Counter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Besides these general purpose registers, there is a 16-bit program counter which is ofter referred to as <code>PC</code>.
The program counter is basically a pointer that refers to the next instruction to be executed.
When executing instructions the program the program counter automatically gets incremented but there are also instructions that explicitly set the program counter.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conditional_codes">Conditional Codes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The LC-3 contains three conditional codes which are set by some instruction.
The three conditional codes are <code>N</code> (negative), <code>Z</code> (zero), and <code>P</code> (positive).
Most instructions that modify the contents of a register set these codes according to the final value of that register.
If the two&#8217;s complement value of that register is less than zero, the <code>N</code> flag will get set.
If the value is equal to zero, the <code>Z</code> flag gets set.
And if the final value is greater than zero, the <code>P</code> flag gets set.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instruction_encoding">Instruction Encoding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The four most significant bits of an instruction form the opcode.
The LC-3 architecture knows 15 distinct operations, which are listed below in the form of an <code>enum class</code>, but can also be found in the ISA at page number 525.</p>
</div>
<div class="listingblock">
<div class="title">opcodes.h</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span>
<span class="tok-cp">#ifndef OPCODES_H</span>
<span class="tok-cp">#define OPCODES_H</span>

<span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">enum</span><span class="tok-w"> </span><span class="tok-k">class</span><span class="tok-w"> </span><span class="tok-nc">opcode</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">ADD</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b0001</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">AND</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b0101</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">BR</span><span class="tok-w">   </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b0000</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">JMP</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b1100</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">JSR</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b0100</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">LD</span><span class="tok-w">   </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b0010</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">LDI</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b1010</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">LDR</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b0110</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">LEA</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b1110</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">NOT</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b1001</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">RTI</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b1000</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">ST</span><span class="tok-w">   </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b0011</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">STI</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b1011</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">STR</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b0111</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">TRAP</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mb">0b1111</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-cp">#endif</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Instructions consist of opcodes and operands.
When looking at the instruction encodings (ISA page number 525) I found that the encoding of many operand types follow a similar pattern.
For example, instruction that use a desination register, always encode the register index for this operand at bits 11 till 9.
When looking at any other types, the same pattern can be found.
All the types are listed below together with the bits they occupy in encodings.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Term</th>
<th class="tableblock halign-left valign-top">Bits</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination Register (<code>DR</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11..9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source Register (<code>SR</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11..9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source Register 1 (<code>SR1</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8..6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source Register 2 (<code>SR2</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2..0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base Register (<code>BaseR</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8..6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5-bit Immediate Value (<code>imm5</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4..0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6-bit Offset Value (<code>offset6</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5..0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9-bit PC Offset Value (<code>PCoffset9</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8..0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">11-bit PC Offset Value (<code>PCoffset11</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10..0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8-bit Trap Vector Value (<code>trapvect8</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7..0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A nice thing of this pattern is that every type can be represented using a width and an index (where <code>0</code> refers the the LSB).
Below I you can see how I&#8217;ve represented these types  in C&#43;&#43;.
The <code>lc3::word</code> and <code>lc3::sword</code> are aliases defined in this header but will only used later by other parts of the program.
A word in a computer is often an integer value that is the same size as registers, which in case of the LC-3 is 16-bits.</p>
</div>
<div class="listingblock">
<div class="title">types.h</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span>
<span class="tok-cp">#ifndef TYPES_H</span>
<span class="tok-cp">#define TYPES_H</span>

<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;cstdint&gt;</span>

<span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">using</span><span class="tok-w"> </span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-kt">uint16_t</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-k">using</span><span class="tok-w"> </span><span class="tok-n">sword</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-kt">int16_t</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;</span><span class="tok-k">typename</span><span class="tok-w"> </span><span class="tok-nc">T</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-k">concept</span><span class="tok-w"> </span><span class="tok-nc">type</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">requires</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">T</span><span class="tok-o">::</span><span class="tok-n">width</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-n">T</span><span class="tok-o">::</span><span class="tok-n">index</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">};</span>

<span class="tok-w">    </span><span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-nc">DR</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">static</span><span class="tok-w"> </span><span class="tok-k">constexpr</span><span class="tok-w"> </span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">width</span><span class="tok-p">{</span><span class="tok-mi">3</span><span class="tok-p">};</span>
<span class="tok-w">        </span><span class="tok-k">static</span><span class="tok-w"> </span><span class="tok-k">constexpr</span><span class="tok-w"> </span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">index</span><span class="tok-p">{</span><span class="tok-mi">9</span><span class="tok-p">};</span>
<span class="tok-w">    </span><span class="tok-p">};</span>

<span class="tok-w">    </span><span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-nc">SR</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">static</span><span class="tok-w"> </span><span class="tok-k">constexpr</span><span class="tok-w"> </span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">width</span><span class="tok-p">{</span><span class="tok-mi">3</span><span class="tok-p">};</span>
<span class="tok-w">        </span><span class="tok-k">static</span><span class="tok-w"> </span><span class="tok-k">constexpr</span><span class="tok-w"> </span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">index</span><span class="tok-p">{</span><span class="tok-mi">9</span><span class="tok-p">};</span>
<span class="tok-w">    </span><span class="tok-p">};</span>

<span class="tok-w">    </span><span class="tok-cm">/* etc.. */</span>
<span class="tok-p">}</span>

<span class="tok-cp">#endif</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instruction_decoding">Instruction Decoding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we&#8217;ve defined which bits each type occupies, we can make functions to extract the bits of these types.
<code>lc3::extract</code> extracts a single type from 16-bit data.
<code>lc3::decode</code> extracts a variable amount of type from 16-bit data.
<code>lc3::bit_at</code> extracts a single bit from an integer.</p>
</div>
<div class="listingblock">
<div class="title">encoding.h</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span>
<span class="tok-cp">#ifndef ENCODING_H</span>
<span class="tok-cp">#define ENCODING_H</span>

<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;lc3/types.h&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;array&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;concepts&gt;</span>

<span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;</span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-kt">size_t</span><span class="tok-w"> </span><span class="tok-n">N</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bit_at</span><span class="tok-p">(</span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">integral</span><span class="tok-w"> </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-n">N</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;</span><span class="tok-n">type</span><span class="tok-w"> </span><span class="tok-n">T</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">extract</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-n">a</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">static_cast</span><span class="tok-o">&lt;</span><span class="tok-n">word</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-n">T</span><span class="tok-o">::</span><span class="tok-n">index</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">zero_extend</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;</span><span class="tok-n">type</span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-n">Ts</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">array</span><span class="tok-o">&lt;</span><span class="tok-n">word</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">sizeof</span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">Ts</span><span class="tok-p">)</span><span class="tok-o">&gt;</span><span class="tok-p">{(</span><span class="tok-n">extract</span><span class="tok-o">&lt;</span><span class="tok-n">Ts</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">))...};</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-cp">#endif</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_memory">Memory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The LC-3 architecture uses 16-bit wide addresses, each of these addresses refers to a 16-bit location in memory.
As for now, a simple <code>std::array</code> can be used for memory.
I made it a type alias for allowing us to easily change its defenition in the future.
This can come in handy when we want to implement memory mapped IO.</p>
</div>
<div class="listingblock">
<div class="title">memory.h</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span>
<span class="tok-cp">#ifndef MEMORY_H</span>
<span class="tok-cp">#define MEMORY_H</span>

<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;lc3/types.h&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;array&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;limits&gt;</span>

<span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">using</span><span class="tok-w"> </span><span class="tok-n">memory</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">array</span><span class="tok-o">&lt;</span><span class="tok-n">sword</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mh">0x10000</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-cp">#endif</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_cpu">The CPU</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below I&#8217;ve pasted the declaration of a structure that represents a LC-3 CPU.
It&#8217;s quite a lot compared to the other code listings, but I will explain everything in detail.</p>
</div>
<div class="listingblock">
<div class="title">cpu.h</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span>
<span class="tok-cp">#ifndef CPU_H</span>
<span class="tok-cp">#define CPU_H</span>

<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;lc3/memory.h&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;lc3/opcodes.h&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;lc3/types.h&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;algorithm&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ranges&gt;</span>

<span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">class</span><span class="tok-w"> </span><span class="tok-nc">cpu</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">public</span><span class="tok-o">:</span>
<span class="tok-w">        </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">load</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">ranges</span><span class="tok-o">::</span><span class="tok-n">input_range</span><span class="tok-w"> </span><span class="tok-k">auto</span><span class="tok-o">&amp;</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">offset</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mh">0x0000</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">ranges</span><span class="tok-o">::</span><span class="tok-n">copy</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">next</span><span class="tok-p">(</span><span class="tok-n">m_memory</span><span class="tok-p">.</span><span class="tok-n">begin</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">offset</span><span class="tok-p">));</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">run</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-k">private</span><span class="tok-o">:</span>
<span class="tok-w">        </span><span class="tok-k">template</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-w"> </span><span class="tok-n">Opcode</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">perform</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">setcc</span><span class="tok-p">(</span><span class="tok-n">sword</span><span class="tok-w"> </span><span class="tok-n">value</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">m_pc</span><span class="tok-p">{</span><span class="tok-mh">0x3000</span><span class="tok-p">};</span>

<span class="tok-w">        </span><span class="tok-n">sword</span><span class="tok-w"> </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-mi">8</span><span class="tok-p">]{};</span>

<span class="tok-w">        </span><span class="tok-n">memory</span><span class="tok-w"> </span><span class="tok-n">m_memory</span><span class="tok-p">{};</span>

<span class="tok-w">        </span><span class="tok-kt">bool</span><span class="tok-w"> </span><span class="tok-n">m_halted</span><span class="tok-p">{};</span>

<span class="tok-w">        </span><span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-w">            </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">z</span><span class="tok-w"> </span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-w">            </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-n">m_condition</span><span class="tok-p">{</span><span class="tok-mi">0</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">};</span>
<span class="tok-w">    </span><span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-cp">#endif</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_the_public_interface">The Public Interface</h3>
<div class="paragraph">
<p>The public interface of the <code>lc3::cpu</code> class consists of three member functions: <code>lc3::cpu::load</code>, <code>lc3::cpu::execute</code>, and <code>lc3::cpu::run</code>.
The <code>lc3::cpu::load</code> function is for loading programs into memory.
It accepts any sequence of 16-bit data that conforms to the <code>std::ranges::input_range</code> concept.
By default the program gets loaded at address <code>0x0000</code> but an optional parameter can be specified in order to load it at a different offset.
The <code>lc3::cpu::execute</code> function accepts a single machine code instruction and executes it.
The <code>lc3::cpu::run</code> function keeps executing machine code instructions starting at the current program counter and keeps doing this till the CPU gets halted (which will later be explained how to).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">cpu::execute</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-n">op</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">static_cast</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">12</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">op</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-no">opcode</span><span class="tok-o">::</span><span class="tok-no">ADD</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">ADD</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-k">break</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-no">opcode</span><span class="tok-o">::</span><span class="tok-no">AND</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">AND</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-k">break</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-no">opcode</span><span class="tok-o">::</span><span class="tok-no">BR</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">BR</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-k">break</span><span class="tok-p">;</span>
<span class="tok-w">            </span><span class="tok-c1">// etc...</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">cpu::run</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">m_halted</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">m_pc</span><span class="tok-o">++</span><span class="tok-p">]);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-n">m_halted</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">false</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_implementation_details">The Implementation Details</h3>
<div class="paragraph">
<p>On second thought it does not make much sense to keep the memory inside the CPU since they&#8217;re different units.
It would make more sense if they both were part of a class that represents the machine as a whole (alternatively rename <code>lc3::cpu</code> to <code>lc3::machine</code>).
Once I&#8217;ve noticed this, I was already working on this document and did not bother to change it anymore.
However, it is something I would take in consideration if writing a virtual machine ever again.</p>
</div>
<div class="paragraph">
<p><code>lc3::cpu::perform</code> member function takes an opcode as template parameter and an encoded instruction as regular parameter.
For each opcode, I&#8217;ve defined a template specialization.</p>
</div>
<div class="paragraph">
<p><code>lc3::cpu::setcc</code> is a small member function used to set the conditional codes according to the state of the value passed to it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">cpu::setcc</span><span class="tok-p">(</span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-kt">int16_t</span><span class="tok-w"> </span><span class="tok-n">value</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">m_condition</span><span class="tok-p">.</span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">m_condition</span><span class="tok-p">.</span><span class="tok-n">z</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">m_condition</span><span class="tok-p">.</span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Whats left are the private data members.
There is a program counter (<code>m_pc</code>), eight general purpose registers (<code>m_regs</code>), a boolean value that indicates whether the CPU is halted (<code>m_halted</code>), and the conditional codes (<code>m_condition</code>).
The program counter starts at address <code>0x3000</code> since that is where the memory section available for user program starts and most example programs found online expect the <code>PC</code> to start there.</p>
</div>
</div>
<div class="sect2">
<h3 id="_operations">Operations</h3>
<div class="paragraph">
<p>In this section I will explain how I&#8217;ve implemented 15 operations.
I&#8217;m going to roughly explain what each operation does and how I&#8217;ve implemented it.
For a more detailed description, consult the ISA.
The ISA contain pseudo code for the logic behind each instruction which was really helpful to me.</p>
</div>
</div>
<div class="sect2">
<h3 id="_addition">Addition</h3>
<div class="paragraph">
<p>The first operation that I&#8217;ve implemented is addition.
This operation has two variants, one where both source operands are registers, and another one where the first source operand is a register while the second is a 5-bit signed integer value.
The 5<sup>th</sup> bit of the encoded instruction indicates which of these variants should be executed.
If this bit is cleared, addition should be performed between two registers; otherwise, addition between a register and an immediate value must be performed.</p>
</div>
<div class="listingblock">
<div class="title">Performing Addition</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">ADD</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">bit_at</span><span class="tok-o">&lt;</span><span class="tok-mi">5</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">DR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">SR1</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">SR2</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">b</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">c</span><span class="tok-p">];</span>
<span class="tok-w">            </span><span class="tok-n">setcc</span><span class="tok-p">(</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">DR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">SR1</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">imm5</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">b</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">imm5</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">setcc</span><span class="tok-p">(</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bit_wise_logical_and">Bit-wise Logical AND</h3>
<div class="paragraph">
<p>The bit-wise AND operation is almost identical to addition operation except for that instead of the <code>+</code> operator, the <code>&amp;</code> operator should be used.
For this reason I won&#8217;t show the listing of the bitwise AND operation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conditional_branch">Conditional Branch</h3>
<div class="paragraph">
<p>This is the first operation that modifies control flow. It modifies the program counter explicitly based on the state of the conditional codes.
The encoding consists of an offset and three bits which indicate what condition to check for.
If the 11<sup>th</sup>, 10<sup>th</sup>, or 9<sup>th</sup> bits are set, the offset will be added to the program counter if also the conditional code <code>n</code> (negative), <code>z</code> (zero), or <code>p</code> (positive) are set respecitvely.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">BR</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">offset</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">bit_at</span><span class="tok-o">&lt;</span><span class="tok-mi">11</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">m_condition</span><span class="tok-p">.</span><span class="tok-n">n</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">bit_at</span><span class="tok-o">&lt;</span><span class="tok-mi">10</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">m_condition</span><span class="tok-p">.</span><span class="tok-n">z</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">bit_at</span><span class="tok-o">&lt;</span><span class="tok-mi">9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">m_condition</span><span class="tok-p">.</span><span class="tok-n">p</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jump">Jump</h3>
<div class="paragraph">
<p>This unlike <code>BR</code>, this operation unconditionally sets the program counter to the value of a source register.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">JMP</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">BaseR</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">];</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jump_to_subroutine">Jump to Subroutine</h3>
<div class="paragraph">
<p>This operation is similar to <code>JMP</code> but works a bit differently.
First, the current program counter gets copied into <code>R7</code>.
Then if the 11<sup>th</sup> bit of the encoded instruction is set, a jump operation will be performed, else an offset will be added to the program counter.
The reason the program counter gets copied into <code>R7</code> is so that after the procedure is done, it can return to the address it got called from.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">JSR</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-mi">7</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_pc</span><span class="tok-p">;</span>

<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">bit_at</span><span class="tok-o">&lt;</span><span class="tok-mi">11</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">BaseR</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">];</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">offset</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset11</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset11</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_load">Load</h3>
<div class="paragraph">
<p>Operations such as <code>ADD</code> and <code>AND</code> only take registers or immediate values as source operands.
Sometimes, however, we need to perform these operations on values stored in memory.
The <code>LC-3</code> provides various operations for loading values from memory into registers.
Once the value is into a register we can use it for the desired operation.
<code>LD</code> is the first of these operation I&#8217;m going to cover.
The encoding consists of a source register and a 9-bit offset that is relative to the program counter.
The value stored at this offset in memory is what gets copied into the destination register.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">LD</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">offset</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">DR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">)];</span>
<span class="tok-w">        </span><span class="tok-n">setcc</span><span class="tok-p">(</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">]);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_load_indirect">Load Indirect</h3>
<div class="paragraph">
<p>This operation (<code>LDI</code>) is similar to the <code>LD</code> operation.
Its encoding also contains a <code>pcOffset9</code> but instead of just loading the value at this offset, it interprets the value at this offset as another address, the value at this address will get loaded into the desination register.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">LDI</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">offset</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">DR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">)]];</span>
<span class="tok-w">        </span><span class="tok-n">setcc</span><span class="tok-p">(</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">]);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_load_baseoffset">Load Base+offset</h3>
<div class="paragraph">
<p>Just like <code>LDI</code>, this operation is also similar to <code>LD</code>.
The <code>LD</code> operation has a <code>pcOffset9</code> as operand, which is an offset relative to the program counter.
With this operation however, a base register can be specified.
Its second operand is a <code>offset6</code> which is the offset relative to the base register.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">LDR</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">offset</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">DR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">BaseR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">offset6</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">b</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">offset6</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">)];</span>
<span class="tok-w">        </span><span class="tok-n">setcc</span><span class="tok-p">(</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_load_effective_address">Load Effective Address</h3>
<div class="paragraph">
<p>This operation is again similar to <code>LD</code> but doesn&#8217;t dereference the result.
It just stores the address you get when adding the program counter  to the offset into the destination register.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">LEA</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">offset</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">DR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">setcc</span><span class="tok-p">(</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">]);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bit_wise_complement">Bit-Wise Complement</h3>
<div class="paragraph">
<p>This operation simply negates all bits of a general purpose register.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">NOT</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">b</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">DR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">SR1</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">b</span><span class="tok-p">];</span>
<span class="tok-w">        </span><span class="tok-n">setcc</span><span class="tok-p">(</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_store">Store</h3>
<div class="paragraph">
<p>This operation copies the contents of a register into a memory location.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">ST</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">reg</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">offset</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">SR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-n">address</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">address</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">reg</span><span class="tok-p">];</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_store_indirect">Store Indirect</h3>
<div class="paragraph">
<p>This operation is similar to <code>LDI</code> but instead of loading the value an address points to, it copies the contents of a register to the memory an address points to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">STI</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">reg</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">offset</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">SR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-n">address</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">m_pc</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">PCoffset9</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">)];</span>
<span class="tok-w">        </span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">address</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">reg</span><span class="tok-p">];</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_store_baseoffset">Store Base+offset</h3>
<div class="paragraph">
<p>The <code>ST</code> operation has a <code>pcOffset9</code> as operand, which is an offset relative to the program counter.
With this operation however, a base register can be specified.
Its second operand is a <code>offset6</code> which is the offset relative to the base register.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">STR</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">offset</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">SR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">BaseR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">offset6</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">b</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">sign_extend</span><span class="tok-o">&lt;</span><span class="tok-n">offset6</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">offset</span><span class="tok-p">)]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">];</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_system_call">System Call</h3>
<div class="paragraph">
<p>System calls provide a way for user programs to interact with the operating system.
The <code>TRAP</code> operation (system call) can be used to call Trap Service Routines.
Normally these routines are located somewhere in memory but I&#8217;ve decided to hardcode them.
The encoded instruction contains a trap vector (<code>trapvect8</code>) that indicates what type of system call needs to be performed.
A detailed description about what each system call does can be found on page number 543 of the ISA.
Below I&#8217;ve put a very brief description.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Descriptoin</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GETC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read a single character and store it in R0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write a single character from R0 to the console.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write a null-terminated string to the console.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prompt the user for a character and the same as GETC.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HALT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Halts the CPU.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">namespace</span><span class="tok-w"> </span><span class="tok-nn">lc3</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">template</span><span class="tok-o">&lt;&gt;</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-o">::</span><span class="tok-n">perform</span><span class="tok-o">&lt;</span><span class="tok-n">opcode</span><span class="tok-o">::</span><span class="tok-n">TRAP</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">bin</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">enum</span><span class="tok-w"> </span><span class="tok-k">class</span><span class="tok-w"> </span><span class="tok-nc">vectors</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">GETC</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mh">0x20</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">OUT</span><span class="tok-w">   </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mh">0x21</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">PUTS</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mh">0x22</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">IN</span><span class="tok-w">    </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mh">0x23</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">PUTSP</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mh">0x24</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">HALT</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mh">0x25</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-p">};</span>

<span class="tok-w">        </span><span class="tok-k">using</span><span class="tok-w"> </span><span class="tok-k">enum</span><span class="tok-w"> </span><span class="tok-nc">vectors</span><span class="tok-p">;</span>

<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">trapvect</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">decode</span><span class="tok-o">&lt;</span><span class="tok-n">trapvect8</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">bin</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-n">vector</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">static_cast</span><span class="tok-o">&lt;</span><span class="tok-n">vectors</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">trapvect</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-c1">// character input</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">vector</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">GETC</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">vector</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">IN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">vector</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">IN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">cout</span><span class="tok-w"> </span><span class="tok-o">&lt;&lt;</span><span class="tok-w"> </span><span class="tok-s">&quot;Enter a character.</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">cin</span><span class="tok-p">.</span><span class="tok-n">get</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-c1">// character output</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">vector</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">OUT</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">cout</span><span class="tok-w"> </span><span class="tok-o">&lt;&lt;</span><span class="tok-w"> </span><span class="tok-k">static_cast</span><span class="tok-o">&lt;</span><span class="tok-kt">char</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-c1">// string output</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">vector</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">PUTS</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-n">address</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m_regs</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">];</span><span class="tok-w"> </span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">address</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-o">++</span><span class="tok-n">address</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-n">ch</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">static_cast</span><span class="tok-o">&lt;</span><span class="tok-kt">char</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">m_memory</span><span class="tok-p">[</span><span class="tok-n">address</span><span class="tok-p">]);</span>
<span class="tok-w">                </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">cout</span><span class="tok-w"> </span><span class="tok-o">&lt;&lt;</span><span class="tok-w"> </span><span class="tok-n">ch</span><span class="tok-p">;</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-c1">// halting the CPU</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">vector</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">HALT</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">m_halted</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">true</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">vector</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">PUTSP</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">logic_error</span><span class="tok-p">{</span><span class="tok-s">&quot;ERROR: PUTSP is not implemented&quot;</span><span class="tok-p">};</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_testing_the_vm">Testing the VM</h3>
<div class="paragraph">
<p>From <a href="http://lc3tutor.org" class="bare">lc3tutor.org</a> I&#8217;ve taken an example program, assembled it, and downloaded it as object file.
The program reverses the contents of a hard coded string and prints it to the terminal.</p>
</div>
<div class="paragraph">
<p>The structure of the object file is very simple.
The first word contains the address where the program should be loaded, the rest is just the assembled program.
When reading the words, the order of the bytes should get swapped, because the object file uses little-endian.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;lc3/cpu.h&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;bit&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;fstream&gt;</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;vector&gt;</span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">lc3</span><span class="tok-o">::</span><span class="tok-n">cpu</span><span class="tok-w"> </span><span class="tok-n">cpu</span><span class="tok-p">{};</span>

<span class="tok-w">    </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">ifstream</span><span class="tok-w"> </span><span class="tok-n">ifs</span><span class="tok-p">{</span><span class="tok-s">&quot;../reverse-string.o&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">ios</span><span class="tok-o">::</span><span class="tok-n">binary</span><span class="tok-p">};</span>

<span class="tok-w">    </span><span class="tok-k">auto</span><span class="tok-w"> </span><span class="tok-n">read</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-o">&amp;</span><span class="tok-n">ifs</span><span class="tok-p">]()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">lc3</span><span class="tok-o">::</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">word</span><span class="tok-p">{};</span>
<span class="tok-w">        </span><span class="tok-n">ifs</span><span class="tok-p">.</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-k">reinterpret_cast</span><span class="tok-o">&lt;</span><span class="tok-kt">char</span><span class="tok-o">*&gt;</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">word</span><span class="tok-p">),</span><span class="tok-w"> </span><span class="tok-k">sizeof</span><span class="tok-w"> </span><span class="tok-n">word</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">byteswap</span><span class="tok-p">(</span><span class="tok-n">word</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">};</span>

<span class="tok-w">    </span><span class="tok-n">lc3</span><span class="tok-o">::</span><span class="tok-n">word</span><span class="tok-w"> </span><span class="tok-n">origin</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">read</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">vector</span><span class="tok-o">&lt;</span><span class="tok-n">lc3</span><span class="tok-o">::</span><span class="tok-n">word</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">program</span><span class="tok-p">{};</span>
<span class="tok-w">    </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">ifs</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">program</span><span class="tok-p">.</span><span class="tok-n">push_back</span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-n">cpu</span><span class="tok-p">.</span><span class="tok-n">load</span><span class="tok-p">(</span><span class="tok-n">program</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">origin</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">cpu</span><span class="tok-p">.</span><span class="tok-n">run</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When executing this program the output is <code>fedcba</code>.
This is correct because the hard coded string was <code>abcdef</code>.
<a href="http://lc3tutor.org" class="bare">lc3tutor.org</a> offers more example programs that can be tried or you can write your own.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-03-03 21:37:52 +0100
</div>
</div>
</body>
</html>